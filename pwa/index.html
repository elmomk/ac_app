<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC Controller</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c2c2c">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .ac-card {
            background-color: #2c2c2c;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            border: 1px solid #4a4a4a;
        }

        .control-button {
            border-radius: 9999px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .control-button:active:not(:disabled) {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .button-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .control-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Slider specific styles */
        #temp-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4a4a4a;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        #temp-slider:hover {
            opacity: 1;
        }

        #temp-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 50%;
            cursor: pointer;
            border: 4px solid #2c2c2c;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        #temp-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 50%;
            cursor: pointer;
            border: 4px solid #2c2c2c;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        #temp-slider.cold::-webkit-slider-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E‚ùÑÔ∏è%3C/text%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 60%;
        }
        #temp-slider.hot::-webkit-slider-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüî•%3C/text%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 60%;
        }
        #temp-slider.cold::-moz-range-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E‚ùÑÔ∏è%3C/text%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 60%;
        }
        #temp-slider.hot::-moz-range-thumb {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüî•%3C/text%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 60%;
        }
    </style>
</head>

<body>

    <div id="ac-container" class="ac-card flex flex-col items-center">
        <!-- Main Display -->
        <div class="w-full text-center mb-6">
            <div class="text-4xl font-bold mb-2" id="temp-display">--¬∞C</div>
            <div class="text-lg font-medium text-gray-400" id="status-text">OFF</div>
            <!-- Temperature Slider -->
            <div id="slider-container" class="w-full px-4 opacity-0 transition-opacity mt-4">
                <input type="range" id="temp-slider" min="21" max="30" step="1" class="w-full">
            </div>
        </div>

        <!-- AC State Icons -->
        <div class="flex justify-around w-full max-w-sm mb-8">
            <div id="mode-icon-container" class="flex flex-col items-center opacity-30 transition-opacity">
                <span class="text-4xl" id="mode-icon"></span>
                <span class="mt-1 text-sm text-gray-400" id="mode-text"></span>
            </div>
            <div id="fan-icon-container" class="flex flex-col items-center opacity-30 transition-opacity">
                <span class="text-4xl" id="fan-icon"></span>
                <span class="mt-1 text-sm text-gray-400" id="fan-text"></span>
            </div>
        </div>

        <!-- Power Button -->
        <div class="mb-8">
            <button id="power-btn" class="control-button bg-gray-600 hover:bg-red-500 transition-colors">
                <span id="power-icon" class="text-2xl"></span>
            </button>
        </div>

        <!-- Temperature Controls -->
        <div class="flex items-center space-x-4 mb-8">
            <button id="temp-down-btn" class="control-button bg-gray-700 hover:bg-gray-600 transition-colors">
                <span class="text-2xl text-white">-</span>
            </button>
            <div class="text-xl font-medium">Temperature</div>
            <button id="temp-up-btn" class="control-button bg-gray-700 hover:bg-gray-600 transition-colors">
                <span class="text-2xl text-white">+</span>
            </button>
        </div>

        <!-- Mode and Fan Speed Controls (Now with dropdowns) -->
        <div class="flex justify-between w-full max-w-xs space-x-4">
            <!-- Mode Dropdown -->
            <div class="relative w-1/2">
                <button id="mode-dropdown-btn" class="w-full flex flex-col items-center p-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition-colors">
                    <span class="text-3xl mb-1" id="control-mode-icon"></span>
                    <span class="button-text">Mode</span>
                </button>
                <div id="mode-dropdown-menu" class="absolute z-10 hidden mt-2 origin-top-left rounded-md bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="horizontal" tabindex="-1">
                    <div class="flex p-1" role="none">
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="mode-cool-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">‚ùÑÔ∏è</span>
                                <span>Cool</span>
                            </div>
                        </button>
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="mode-heat-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">üî•</span>
                                <span>Heat</span>
                            </div>
                        </button>
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="mode-fan-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">üí®</span>
                                <span>Fan</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Fan Speed Dropdown -->
            <div class="relative w-1/2">
                <button id="fan-dropdown-btn" class="w-full flex flex-col items-center p-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition-colors">
                    <span class="text-3xl mb-1" id="control-fan-icon"></span>
                    <span class="button-text">Fan</span>
                </button>
                <div id="fan-dropdown-menu" class="absolute z-10 hidden mt-2 origin-top-right rounded-md bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="horizontal" tabindex="-1">
                    <div class="flex p-1" role="none">
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="fan-auto-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">ü§ñ</span>
                                <span>Auto</span>
                            </div>
                        </button>
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="fan-low-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">üå¨Ô∏è</span>
                                <span>Low</span>
                            </div>
                        </button>
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="fan-medium-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">üí®</span>
                                <span>Medium</span>
                            </div>
                        </button>
                        <button class="px-3 py-2 mx-1 text-sm text-white rounded hover:bg-gray-600" role="menuitem" id="fan-high-option">
                            <div class="flex flex-col items-center">
                                <span class="text-xl">üå™Ô∏è</span>
                                <span>High</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Temperature configuration
        const TEMP_MIN = 21;  // Minimum temperature in Celsius
        const TEMP_MAX = 30;  // Maximum temperature in Celsius
        
        // State variables for the simulated AC
        let acState = {
            isOn: false,
            temperature: 22, // in Celsius
            mode: 'Cool',
            fanSpeed: 'Low'
        };

        // A variable to track if an API request is in progress
        let isSending = false;

        // UI elements
        const tempDisplay = document.getElementById('temp-display');
        const statusText = document.getElementById('status-text');
        const powerBtn = document.getElementById('power-btn');
        const tempUpBtn = document.getElementById('temp-up-btn');
        const tempDownBtn = document.getElementById('temp-down-btn');
        const acContainer = document.getElementById('ac-container');
        const modeIconContainer = document.getElementById('mode-icon-container');
        const fanIconContainer = document.getElementById('fan-icon-container');
        const modeIcon = document.getElementById('mode-icon');
        const modeText = document.getElementById('mode-text');
        const fanIcon = document.getElementById('fan-icon');
        const fanText = document.getElementById('fan-text');
        const powerIcon = document.getElementById('power-icon');
        const controlModeIcon = document.getElementById('control-mode-icon');
        const controlFanIcon = document.getElementById('control-fan-icon');
        const sliderContainer = document.getElementById('slider-container');
        const tempSlider = document.getElementById('temp-slider');

        // New UI elements for dropdowns
        const modeDropdownBtn = document.getElementById('mode-dropdown-btn');
        const modeDropdownMenu = document.getElementById('mode-dropdown-menu');
        const fanDropdownBtn = document.getElementById('fan-dropdown-btn');
        const fanDropdownMenu = document.getElementById('fan-dropdown-menu');
        const allButtons = [powerBtn, tempUpBtn, tempDownBtn, modeDropdownBtn, fanDropdownBtn];

        // Function to toggle dropdown visibility
        function toggleDropdown(dropdownMenu) {
            dropdownMenu.classList.toggle('hidden');
        }

        // Function to render the current state to the UI
        function renderState() {
            // Disable buttons if a command is being sent
            allButtons.forEach(btn => btn.disabled = isSending);
            tempSlider.disabled = isSending || !acState.isOn;

            if (isSending) {
                statusText.textContent = 'Sending...';
                return;
            }

            if (acState.isOn) {
                // AC is ON
                acContainer.classList.add('bg-gray-800');
                acContainer.classList.remove('bg-gray-900');
                tempDisplay.textContent = `${acState.temperature}¬∞C`;
                statusText.textContent = 'ON';
                powerIcon.textContent = '‚ö°'; // Power icon
                modeIconContainer.classList.remove('opacity-30');
                fanIconContainer.classList.remove('opacity-30');
                powerBtn.classList.add('bg-red-500');
                powerBtn.classList.remove('bg-gray-600');
                sliderContainer.classList.remove('opacity-0');
                tempSlider.value = acState.temperature;

                // Update slider thumb icon
                if (acState.temperature <= 23) {
                    tempSlider.classList.add('cold');
                    tempSlider.classList.remove('hot');
                } else if (acState.temperature >= 28) {
                    tempSlider.classList.add('hot');
                    tempSlider.classList.remove('cold');
                } else {
                    tempSlider.classList.remove('cold');
                    tempSlider.classList.remove('hot');
                }
            } else {
                // AC is OFF
                acContainer.classList.add('bg-gray-900');
                acContainer.classList.remove('bg-gray-800');
                tempDisplay.textContent = '--¬∞C';
                statusText.textContent = 'OFF';
                powerIcon.textContent = '‚ö™'; // Off icon
                modeIconContainer.classList.add('opacity-30');
                fanIconContainer.classList.add('opacity-30');
                powerBtn.classList.remove('bg-red-500');
                powerBtn.classList.add('bg-gray-600');
                sliderContainer.classList.add('opacity-0');
                tempSlider.classList.remove('cold');
                tempSlider.classList.remove('hot');
            }

            // Update mode display
            switch (acState.mode) {
                case 'Cool':
                    modeIcon.textContent = '‚ùÑÔ∏è'; // Snowflake
                    modeText.textContent = 'Cool';
                    controlModeIcon.textContent = '‚ùÑÔ∏è';
                    break;
                case 'Heat':
                    modeIcon.textContent = 'üî•'; // Fire
                    modeText.textContent = 'Heat';
                    controlModeIcon.textContent = 'üî•';
                    break;
                case 'Fan':
                    modeIcon.textContent = 'üí®'; // Wind
                    modeText.textContent = 'Fan';
                    controlModeIcon.textContent = 'üí®';
                    break;
            }

            // Update fan speed display
            switch (acState.fanSpeed) {
                case 'Auto':
                    fanIcon.textContent = 'ü§ñ';
                    fanText.textContent = 'Auto';
                    controlFanIcon.textContent = 'ü§ñ';
                    break;
                case 'Low':
                    fanIcon.textContent = 'üå¨Ô∏è';
                    fanText.textContent = 'Low';
                    controlFanIcon.textContent = 'üå¨Ô∏è';
                    break;
                case 'Medium':
                    fanIcon.textContent = 'üí®';
                    fanText.textContent = 'Medium';
                    controlFanIcon.textContent = 'üí®';
                    break;
                case 'High':
                    fanIcon.textContent = 'üå™Ô∏è';
                    fanText.textContent = 'High';
                    controlFanIcon.textContent = 'üå™Ô∏è';
                    break;
            }
        }

        // API function to send a command
        async function sendCommand(newState) {
            isSending = true;
            renderState();

            // The actual API URL to your FastAPI server
            const apiUrl = 'http://localhost:8000/api/set-state';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newState)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                // If the "API call" is successful, update the local state
                acState = newState;

            } catch (error) {
                console.error('Failed to send command to AC:', error);
                // Handle the error visually, e.g., show an error message on the UI
                statusText.textContent = 'Connection Error';
            } finally {
                isSending = false;
                renderState();
            }
        }

        // Functions to handle button clicks, now calling the async API function
        function togglePower() {
            const newState = { ...acState,
                isOn: !acState.isOn
            };
            sendCommand(newState);
        }

        function adjustTemperature(delta) {
            if (acState.isOn) {
                const newTemp = acState.temperature + delta;
                if (newTemp >= TEMP_MIN && newTemp <= TEMP_MAX) {
                    const newState = { ...acState,
                        temperature: newTemp
                    };
                    sendCommand(newState);
                }
            }
        }

        function setTemperature(newTemp) {
            if (acState.isOn) {
                newTemp = parseInt(newTemp);
                if (newTemp >= TEMP_MIN && newTemp <= TEMP_MAX) {
                    const newState = { ...acState,
                        temperature: newTemp
                    };
                    sendCommand(newState);
                }
            }
        }

        // Functions for dropdown item selection
        function selectMode(newMode) {
            if (acState.isOn) {
                const newState = { ...acState,
                    mode: newMode
                };
                sendCommand(newState);
                modeDropdownMenu.classList.add('hidden');
            }
        }

        function selectFanSpeed(newSpeed) {
            if (acState.isOn) {
                const newState = { ...acState,
                    fanSpeed: newSpeed
                };
                sendCommand(newState);
                fanDropdownMenu.classList.add('hidden');
            }
        }


        // Event listeners for buttons
        powerBtn.addEventListener('click', togglePower);
        tempUpBtn.addEventListener('click', () => adjustTemperature(1));
        tempDownBtn.addEventListener('click', () => adjustTemperature(-1));
        
        tempSlider.addEventListener('input', (e) => {
            if (acState.isOn) {
                tempDisplay.textContent = `${e.target.value}¬∞C`;
            }
        });

        tempSlider.addEventListener('change', (e) => {
            setTemperature(e.target.value);
        });

        // Event listeners for new dropdown buttons
        // Prevent click from bubbling to the document
        modeDropdownBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleDropdown(modeDropdownMenu);
        });
        fanDropdownBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleDropdown(fanDropdownMenu);
        });

        // Event listeners for dropdown menu items - using event delegation
        document.getElementById('mode-dropdown-menu').addEventListener('click', (event) => {
            const target = event.target.closest('[id^="mode-"]');
            if (!target) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const mode = target.id.replace('mode-', '').replace('-option', '');
            if (mode) {
                selectMode(mode.charAt(0).toUpperCase() + mode.slice(1));
            }
        });

        document.getElementById('fan-dropdown-menu').addEventListener('click', (event) => {
            const target = event.target.closest('[id^="fan-"]');
            if (!target) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const speed = target.id.replace('fan-', '').replace('-option', '');
            if (speed) {
                selectFanSpeed(speed.charAt(0).toUpperCase() + speed.slice(1));
            }
        });

        document.getElementById('fan-high-option').addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            selectFanSpeed('High');
        });

        // Hide dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!modeDropdownMenu.contains(event.target) && !modeDropdownBtn.contains(event.target)) {
                modeDropdownMenu.classList.add('hidden');
            }
            if (!fanDropdownMenu.contains(event.target) && !fanDropdownBtn.contains(event.target)) {
                fanDropdownMenu.classList.add('hidden');
            }
        });

        // Initial render
        renderState();

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
              console.log('SW registered: ', registration);
            }).catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
          });
        }
    </script>
</body>

</html>
